@startuml Reset Password Sequence Diagram
actor User
participant "UI/Client" as UI
participant "Auth Controller" as Controller
participant "Auth Service" as Service
participant "Email Service" as Email
participant "Database" as DB

== Yêu cầu đặt lại mật khẩu ==
User -> UI: Nhập email
UI -> Controller: POST /api/auth/forgot-password
Controller -> Service: requestPasswordReset(email)
Service -> DB: findUserByEmail(email)
DB --> Service: userData

alt User tồn tại
    Service -> Service: generateResetToken()
    Service -> DB: saveResetToken(userId, token, expiry)
    DB --> Service: success
    Service -> Email: sendResetEmail(email, token)
    Email --> Service: sent
    Service --> Controller: success
    Controller --> UI: 200 OK
    UI --> User: Kiểm tra email
else User không tồn tại
    Service --> Controller: success (security)
    Controller --> UI: 200 OK
    UI --> User: Kiểm tra email
end

== Đặt lại mật khẩu ==
User -> UI: Click link + nhập mật khẩu mới
UI -> Controller: POST /api/auth/reset-password
Controller -> Service: resetPassword(token, newPassword)
Service -> DB: findResetToken(token)
DB --> Service: tokenData

alt Token hợp lệ
    Service -> Service: hashPassword(newPassword)
    Service -> DB: updatePassword(userId, hashedPassword)
    Service -> DB: deleteResetToken(token)
    DB --> Service: success
    Service --> Controller: success
    Controller --> UI: 200 OK
    UI --> User: Mật khẩu đã được đặt lại
else Token không hợp lệ/hết hạn
    Service --> Controller: InvalidTokenError
    Controller --> UI: 400 Bad Request
    UI --> User: Link không hợp lệ
end

@enduml
