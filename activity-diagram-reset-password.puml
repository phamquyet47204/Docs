@startuml Reset Password Activity Diagram
start

partition "Yêu cầu đặt lại mật khẩu" {
  :User nhập email;
  :Gửi request forgot password;
  :Tìm user theo email;
  
  if (User tồn tại?) then (yes)
    :Tạo reset token (UUID);
    :Lưu token với expiry (1 giờ);
    :Gửi email với link reset;
  else (no)
    note right
      Vẫn trả về success
      để tránh email enumeration
    end note
  endif
  :Trả về success message;
  :Hiển thị "Kiểm tra email";
}

partition "Đặt lại mật khẩu" {
  :User click link trong email;
  :Nhập mật khẩu mới;
  :Gửi request với token;
  
  :Tìm reset token trong DB;
  if (Token tồn tại?) then (no)
    :Trả về "Link không hợp lệ";
    stop
  endif
  
  if (Token hết hạn?) then (yes)
    :Xóa token;
    :Trả về "Link đã hết hạn";
    stop
  endif
  
  :Validate mật khẩu mới;
  if (Mật khẩu hợp lệ?) then (no)
    :Trả về lỗi validation;
    stop
  endif
  
  :Hash mật khẩu mới;
  :Cập nhật password trong DB;
  :Xóa reset token;
  :Xóa tất cả session của user;
  :Ghi log thay đổi password;
  :Gửi email xác nhận;
  :Trả về success;
  :Chuyển đến trang đăng nhập;
  stop
}

@enduml
